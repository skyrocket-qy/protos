syntax = "proto3";

package authzpb.v1;

import "google/protobuf/empty.proto"; 
import "pkgpb/v1/pkg.proto";

option go_package = "github.com/skyrocket-qy/protos/gen/authzpb/v1;authzpbv1";

service AuthzService {
    rpc CreateTuple(Tuple) returns (google.protobuf.Empty);
    rpc ListTuples(ListTuplesIn) returns (ListTuplesOut);
    rpc DeleteTuples(DeleteTuplesIn) returns (google.protobuf.Empty);
    rpc Check(CheckIn) returns (CheckOut);
}

message CheckIn {
    string sbj_ns = 1;
    string sbj_id = 2;
    string rel = 3;
    string obj_ns = 4;
    string obj_id = 5;
}

message CheckOut {
    bool is_allowed = 1;
}

message Tuple {
    uint64 id = 1;
    string sbj_ns = 2;
    string sbj_id = 3;
    string rel = 4;
    string obj_ns = 5;
    string obj_id = 6;
}

message TupleFilter {
    optional string sbj_ns = 1;
    optional string sbj_id = 2;
    optional string rel = 3;
    optional string obj_ns = 4;
    optional string obj_id = 5;
}

message ListTuplesIn {
    // created_at, email, name, is_email_confirmed, is_active, auth_type, org_name
    repeated pkgpb.v1.Filter filters = 1;
    // created_at, auth_type, org_name
    repeated pkgpb.v1.Sorter sorters = 2;
    pkgpb.v1.Cursor cursor = 3;
}

message ListTuplesOut{
    repeated Tuple tuples = 1;
    bytes next_cursor = 2;
}

message Instance {
    string ns = 1;
    string id = 2;
}

message TreeNode{
    Instance root = 1;
    map<string, TreeNode> children = 2;
}


message DeleteTuplesIn{
    oneof mode{
        DeleteTuples tuples = 1;
        TupleFilter filter = 2;
        DeleteTupleIds ids = 3;
    }
}
message DeleteTuples{
    repeated Tuple tuples = 1;
}
message DeleteTupleIds {
    repeated uint64 ids = 1;
}